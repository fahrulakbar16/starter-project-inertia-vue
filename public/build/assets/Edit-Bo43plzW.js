import{d as v,u as F,z as x,L as O,x as q,e as l,o as c,b,a as r,g as u,D as P,f as y,t as m,F as I,i as M,E as C,h as V,G as E,n as z,H as A}from"./app-CJkCV51W.js";import{_ as K}from"./Breadcrumb-BJQpsGcc.js";import G from"./Form-ZhP-zITN.js";import{_ as H}from"./AppLayout-BlEKf3Fz.js";import{_ as W}from"./SelectBarang-CRvJrPbK.js";import{T as Q}from"./TrashIcon-DSAHmBPH.js";import{v as w}from"./v4-BKrj-4V8.js";import"./SelectPemakaian-bo5sz744.js";import"./FlashMessage-D4C-FUm8.js";import"./LayoutShell-FWpWJLvi.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useAuth-DvuTgkfF.js";import"./LayoutShell.vue_vue_type_style_index_0_lang-CRqqKi3W.js";const X={class:"flex overflow-hidden flex-col gap-3 px-3 h-full"},Y={class:"flex justify-between items-center h-10"},Z={class:"overflow-hidden rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-white/[0.03]"},ee={key:0,class:"text-xs text-rose-600 mt-1"},te={key:1,class:"text-xs text-rose-600 mt-1"},ae={key:2,class:"text-xs text-rose-600 mt-1"},re={key:3,class:"text-xs text-rose-600 mt-1"},se={class:"overflow-hidden rounded-lg border border-gray-200 bg-white dark:border-gray-700 dark:bg-white/[0.03]"},oe={class:"overflow-auto","data-simplebar":""},ie={class:"min-w-full text-sm"},ne={class:"w-4 py-2.5 border-y border-gray-200 dark:border-gray-600"},de={class:"flex items-center whitespace-nowrap justify-center"},ue={class:"px-5 py-2.5 border border-gray-200 dark:border-gray-600"},le={key:0,class:"text-xs text-rose-600 mt-1"},ce={class:"py-2.5 border border-gray-200 dark:border-gray-600"},me={class:"flex items-center px-3 whitespace-nowrap justify-center"},pe={class:"text-gray-500 dark:text-gray-400"},ge={class:"py-2.5 border border-gray-200 dark:border-gray-600"},ye={class:"flex items-center px-3 whitespace-nowrap justify-center"},be={class:"text-gray-500 dark:text-gray-400"},fe={class:"py-2.5 border border-gray-200 dark:border-gray-600"},_e={class:"flex items-center gap-3 ps-6 whitespace-nowrap"},he=["onUpdate:modelValue","max","onInput"],ke={key:0,class:"text-xs text-rose-600 mt-1"},ve={class:"py-2.5 border border-gray-200 dark:border-gray-600"},xe={class:"flex items-center whitespace-nowrap justify-center"},qe=["onUpdate:modelValue"],we={key:0,class:"text-xs text-rose-600 mt-1"},Ne={class:"py-2.5 border-y border-gray-200 dark:border-gray-600"},je={class:"flex justify-center whitespace-nowrap px-4 gap-3"},Be=["onClick"],Ie={key:0,class:"px-6 py-3 text-xs text-rose-600"},Ce={class:"flex items-center gap-5 justify-end"},Ee=["disabled"],Ae={key:0},De={key:1},Ke=Object.assign({layout:H},{__name:"Edit",props:{mr:{type:Object,required:!0},departments:{type:Array,required:!0},employees:{type:Array,required:!0},statusOptions:{type:Array,required:!0},materialRequests:{type:Array,required:!0},items:{type:Array,default:()=>[]},isSuperadmin:{type:Boolean,required:!0}},setup(f){const g=f,p=v([]);function D(t){const e={id:Date.now(),name:t,code:"-",stock:0,unit:{}};return p.value.push(e),e}const S=t=>{const e=d.value.map((a,o)=>o!==t?a.item_id:null).filter(a=>a&&typeof a=="object"&&a.id).map(a=>a.id);return p.value.filter(a=>!e.includes(a.id))};function k(t){x(()=>t.item_id,e=>{if(e){if(typeof e=="object"&&e!==null)t.code=e.code,t.name=e.name,t.stock=e.stock,t.unit=e.unit;else if(typeof e=="string"){const a=D(e);t.item_id=a,t.code=a.code,t.name=a.name,t.stock=a.stock,t.unit=a.unit}}else t.code="",t.name="",t.stock="",t.unit={};_(t)},{immediate:!0}),x(()=>t.stock,()=>{t.item_id&&t.item_id.id&&_(t)})}const d=v([]),n=v([]),N=()=>{const t=q({uid:w(),item_id:null,amount:1,code:"",name:"",stock:"",unit:{},note:""});k(t),d.value.push(t),n.value.push({})},U=t=>{d.value.splice(t,1),n.value.splice(t,1),d.value.forEach(e=>{e.item_id&&e.item_id.id&&_(e)})},J=[{label:"Dashboard",href:route("dashboard")},{label:"Pemakaian Barang",href:route("good-issues.index")},{label:"Ubah Pemakaian Barang"}],i=F({request_id:g.mr.reference_request_id??null,department_id:g.mr.department_id??null,date:g.mr.request_date??"",requirement:g.mr.notes??"",items:[]});x(()=>i.department_id,async t=>{if(!t){p.value=[];return}try{const e=await O.get(route("material-requests.items.by-department"),{params:{department_id:t}});p.value=e.data.items}catch(e){console.error("Error loading items by department:",e),p.value=[]}},{immediate:!0});function _(t){let e,a;if(typeof t=="number"?(e=t,a=d.value[e]):(a=t,e=d.value.findIndex(o=>o.uid===a.uid)),!(e===-1||!a)&&(n.value[e]||(n.value[e]={}),n.value[e].amount&&delete n.value[e].amount,a.item_id&&a.item_id.id)){const o=Number(a.stock),s=Number(a.amount);a.amount===null||a.amount===""||isNaN(s)?n.value[e].amount="Jumlah harus berupa angka bulat.":Number.isInteger(s)?s<1?n.value[e].amount="Jumlah harus minimal 1.":!isNaN(o)&&o>=0&&s>o&&(n.value[e].amount="Jumlah permintaan tidak boleh lebih dari stok tersedia."):n.value[e].amount="Jumlah harus berupa angka bulat."}}function T(){let t=!0;return n.value=[],d.value.length?i.errors.items=null:(i.errors.items=["Minimal 1 item harus diisi."],t=!1),d.value.forEach((e,a)=>{const o={};if(!e.item_id||!e.item_id.id?(o.item_id="Barang harus dipilih.",t=!1):e.item_id&&e.item_id.id&&p.value.length>0&&!p.value.some(s=>s.id===e.item_id.id)&&(o.item_id="Barang tidak valid.",t=!1),e.amount===null||e.amount===""||isNaN(e.amount)||!Number.isInteger(Number(e.amount)))o.amount="Jumlah harus berupa angka bulat.",t=!1;else if(Number(e.amount)<1)o.amount="Jumlah harus minimal 1.",t=!1;else{const s=Number(e.stock),h=Number(e.amount);!isNaN(s)&&s>=0&&h>s&&(o.amount="Jumlah permintaan tidak boleh lebih dari stok tersedia.",t=!1)}e.note&&typeof e.note!="string"?(o.note="Catatan harus berupa teks.",t=!1):e.note&&e.note.length>225&&(o.note="Catatan maksimal 225 karakter.",t=!1),n.value[a]=o}),t}function L(){let t=!0;return i.department_id?g.departments&&!g.departments.some(e=>e.id==i.department_id)&&(i.errors.department_id="Departemen tidak valid.",t=!1):(i.errors.department_id="Departemen harus dipilih.",t=!1),i.date||(i.errors.date="Tanggal harus diisi.",t=!1),i.requirement&&typeof i.requirement!="string"&&(i.errors.requirement="Keterangan harus berupa teks.",t=!1),T()||(t=!1),t}function j(){if(!L())return;const t=d.value.map(a=>({uid:a.uid,item_id:typeof a.item_id=="object"?a.item_id.id:a.item_id,amount:a.amount,note:a.note})),e={request_id:i.request_id,department_id:i.department_id,date:i.date,requirement:i.requirement,items:t};A.put(route("good-issues.update",g.mr.id),e,{onStart:()=>{i.processing=!0},onFinish:()=>{i.processing=!1},onError:a=>{i.errors=a}})}function R(t){if(!(!t||t.length===0)&&(d.value.length===0||d.value.every(e=>!e.item_id||!e.item_id.id))){const e=t.map(s=>({id:s.id,name:s.name,code:s.code,stock:s.stock,unit:s.unit})),a=p.value.map(s=>s.id),o=e.filter(s=>!a.includes(s.id));p.value=[...p.value,...o],d.value=[],n.value=[],t.forEach(s=>{const h=q({uid:w(),item_id:{id:s.id,name:s.name,code:s.code,stock:s.stock,unit:s.unit},amount:s.quantity_approved||s.quantity_requested||1,code:s.code,name:s.name,stock:s.stock,unit:s.unit,note:s.note||""});k(h),d.value.push(h),n.value.push({})})}}function $(){}if(g.items&&g.items.length>0){d.value=g.items.map(e=>{const a=q({uid:w(),item_id:{id:e.item_id,name:e.item_name,code:e.item_code,stock:e.stock?e.stock.last_stock:0,unit:e.unit},amount:e.amount||e.qty||1,code:e.item_code||"",name:e.item_name||"",stock:e.stock?e.stock.last_stock:0,unit:e.unit||{},note:e.note||e.notes||""});return k(a),a}),n.value=new Array(d.value.length).fill({});const t=g.items.map(e=>({id:e.item_id,name:e.item_name,code:e.item_code,stock:e.stock?e.stock.last_stock:0,unit:e.unit}));p.value=[...p.value,...t]}else N();function B(){A.get(route("good-issues.index"))}return(t,e)=>(c(),l(I,null,[b(u(P),{title:"Ubah Log Barang"}),r("div",X,[r("div",Y,[b(K,{items:J})]),r("div",Z,[e[0]||(e[0]=r("h1",{class:"mb-4 text-lg font-semibold text-gray-700 dark:text-gray-200"},"Ubah Log Pemakaian Barang",-1)),b(G,{form:u(i),departments:f.departments,materialRequests:f.materialRequests,isSuperadmin:f.isSuperadmin,isEdit:!0,onSubmit:j,onCancel:B,onItemsLoaded:R,onResetItems:$},null,8,["form","departments","materialRequests","isSuperadmin"]),u(i).errors.department_id?(c(),l("div",ee,m(u(i).errors.department_id),1)):y("",!0),u(i).errors.request_id?(c(),l("div",te,m(u(i).errors.request_id),1)):y("",!0),u(i).errors.date?(c(),l("div",ae,m(u(i).errors.date),1)):y("",!0),u(i).errors.requirement?(c(),l("div",re,m(u(i).errors.requirement),1)):y("",!0)]),r("div",se,[e[2]||(e[2]=r("div",{class:"flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700"},[r("div",{class:"font-semibold text-gray-700 dark:text-gray-200"},"Daftar Item")],-1)),r("div",oe,[r("table",ie,[e[1]||(e[1]=r("thead",null,[r("tr",null,[r("th",{class:"py-2.5 border-y border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center"},[r("p",{class:"flex flex-col items-center font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," No. ")])]),r("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center gap-2 px-3"},[r("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Nama Barang ")])]),r("th",{class:"py-3 border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex cursor-pointer items-center justify-center gap-2 px-3"},[r("p",{class:"font-medium whitespace-nowrap text-gray-500 dark:text-gray-400"}," Kode Barang ")])]),r("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center gap-2 px-3"},[r("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Stok Tersedia ")])]),r("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center gap-2 px-3"},[r("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Jumlah Permintaan ")])]),r("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center gap-2 px-3"},[r("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Catatan ")])]),r("th",{class:"border-y border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[r("div",{class:"flex items-center justify-center"},[r("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Aksi ")])])])],-1)),r("tbody",null,[(c(!0),l(I,null,M(d.value,(a,o)=>(c(),l("tr",{key:a.uid,class:"hover:bg-gray-100 cursor-pointer dark:hover:bg-gray-800"},[r("td",ne,[r("div",de,m(o+1)+". ",1)]),r("td",ue,[b(W,{modelValue:a.item_id,"onUpdate:modelValue":s=>a.item_id=s,items:S(o),taggable:!0,label:"Cari Barang","label-key":"name","search-key":"name"},null,8,["modelValue","onUpdate:modelValue","items"]),n.value[o]&&n.value[o].item_id?(c(),l("div",le,m(n.value[o].item_id),1)):y("",!0)]),r("td",ce,[r("div",me,[r("p",pe,m(a.code),1)])]),r("td",ge,[r("div",ye,[r("p",be,m(a.stock)+" "+m(a.unit?.short_name),1)])]),r("td",fe,[r("div",_e,[C(r("input",{"onUpdate:modelValue":s=>a.amount=s,type:"number",min:1,max:a.stock&&!isNaN(Number(a.stock))?Number(a.stock):void 0,onInput:s=>_(o),class:z(["w-24 rounded border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90",{"border-red-500":n.value[o]&&n.value[o].amount}])},null,42,he),[[E,a.amount,void 0,{number:!0}]]),V(" "+m(a.unit?.short_name),1)]),n.value[o]&&n.value[o].amount?(c(),l("div",ke,m(n.value[o].amount),1)):y("",!0)]),r("td",ve,[r("div",xe,[C(r("input",{"onUpdate:modelValue":s=>a.note=s,type:"text",placeholder:"Masukkan catatan",class:"w-40 h-10 text-sm rounded placeholder:text-gray-600 border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"},null,8,qe),[[E,a.note]])]),n.value[o]&&n.value[o].note?(c(),l("div",we,m(n.value[o].note),1)):y("",!0)]),r("td",Ne,[r("div",je,[r("button",{onClick:s=>U(o)},[b(Q,{class:"text-red-500"})],8,Be)])])]))),128)),r("button",{type:"button",onClick:N,class:"m-4 px-3 py-2 text-white bg-green-500 hover:bg-green-600 rounded whitespace-nowrap"}," + Tambah Item ")])])]),u(i).errors.items?(c(),l("div",Ie,m(u(i).errors.items[0]),1)):y("",!0)]),r("div",Ce,[r("button",{type:"button",onClick:B,class:"inline-flex items-center rounded border bg-gray-400 border-gray-300 px-5 py-2 text-sm text-white hover:text-gray-800 hover:bg-gray-300 dark:border-gray-700 dark:text-gray-300"}," Batal "),r("button",{onClick:j,class:"inline-flex items-center rounded bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60",disabled:u(i).processing},[u(i).processing?(c(),l("span",Ae,"Menyimpan...")):(c(),l("span",De,"Simpan Perubahan"))],8,Ee)])])],64))}});export{Ke as default};
