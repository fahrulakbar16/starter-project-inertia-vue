import{d as k,y as I,x as y,z as v,u as R,l as O,e as m,o as p,b as g,a as t,g as u,D as W,f as x,F as S,i as K,t as d,w as N,E as L,h as M,G as z,L as G,H}from"./app-CJkCV51W.js";import{_ as J}from"./AppLayout-BlEKf3Fz.js";import{_ as Q}from"./Breadcrumb-BJQpsGcc.js";import X from"./Form-CAWNW5uF.js";import{T as Y}from"./TrashIcon-DSAHmBPH.js";import{_ as Z}from"./SelectBarang-CRvJrPbK.js";import{v as b}from"./v4-BKrj-4V8.js";import"./FlashMessage-D4C-FUm8.js";import"./LayoutShell-FWpWJLvi.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useAuth-DvuTgkfF.js";import"./LayoutShell.vue_vue_type_style_index_0_lang-CRqqKi3W.js";import"./SelectPemakaian-bo5sz744.js";const ee={class:"flex overflow-hidden flex-col gap-3 px-3 h-full"},te={class:"flex justify-between items-center h-10"},re={class:"space-y-5 overflow-hidden rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-white/[0.03]"},se={class:"overflow-hidden rounded-lg border border-gray-200 bg-white dark:border-gray-700 dark:bg-white/[0.03]"},ae={class:"overflow-auto","data-simplebar":""},oe={class:"min-w-full text-sm"},ie={class:"w-4 py-2.5 border-y border-gray-200 dark:border-gray-600"},de={class:"flex items-center whitespace-nowrap justify-center"},ne={class:"px-3 py-2.5 border border-gray-200 dark:border-gray-600"},le={class:"flex flex-col py-1"},ce={class:"flex items-center justify-between"},ue={class:"font-medium text-gray-900 dark:text-gray-100 text-sm"},me={key:0,class:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full"},pe={class:"text-xs text-gray-500 dark:text-gray-400"},ye={key:0,class:"text-xs text-rose-600 mt-1"},ge={class:"py-2.5 border border-gray-200 dark:border-gray-600"},be={class:"flex items-center px-3 whitespace-nowrap justify-center"},fe={class:"text-gray-500 dark:text-gray-400"},xe={class:"py-2.5 border border-gray-200 dark:border-gray-600"},he={class:"flex items-center px-3 whitespace-nowrap justify-center"},_e={class:"text-gray-500 dark:text-gray-400"},ke={class:"py-2.5 border border-gray-200 dark:border-gray-600"},ve={class:"flex items-center gap-3 ps-6 whitespace-nowrap"},qe=["onUpdate:modelValue"],we={key:0,class:"text-xs text-rose-600 mt-1"},je={class:"py-2.5 border-y border-gray-200 dark:border-gray-600"},Be={class:"flex justify-center whitespace-nowrap px-4 gap-3"},Ce=["onClick"],De={key:0,class:"px-6 py-3 text-xs text-rose-600"},We=Object.assign({layout:J},{__name:"Create",props:{requestNo:String,user:Object,departments:{type:Array,required:!0},employees:{type:Array,required:!0},items:{type:Array,default:()=>[]},sortBy:String,sortDirection:String},setup(h){const T=[{label:"Penyimpanan"},{label:"Permintaan Barang",href:route("material-requests.index")},{label:"Buat Permintaan"}],n=h,l=k(n.items.map(e=>({id:e.id,name:e.name,code:e.code,stock:e.stock,unit:e.unit})));console.log("Initial options from props:",l.value);const q=async e=>{if(!e){l.value=[];return}try{const r=await G.get(route("material-requests.items.by-department"),{params:{department_id:e},headers:{Accept:"application/json","Content-Type":"application/json"}});r.data&&r.data.items?(l.value=r.data.items.map(s=>({id:s.id,name:s.name,code:s.code,stock:s.stock,unit:s.unit})),console.log("Fetched items:",l.value)):l.value=[]}catch(r){console.error("Error fetching items by department:",r),l.value=[]}},$=e=>{w.value;const r=i.value.map((s,o)=>o!==e&&s.item_id?.id?s.item_id.id:null).filter(s=>s!==null);return l.value.filter(s=>!r.includes(s.id))};I(()=>i.value.map(e=>e.item_id?.id).filter(e=>e!==null));const w=k(0),f=()=>{w.value++},P=(e,r)=>i.value.some((s,o)=>o!==r&&s.item_id?.id===e);function E(e){const r={id:Date.now(),name:e,code:"-",stock:0};return l.value.push(r),r}const i=k([y({uid:b(),item_id:null,request:1,code:"",name:"",stock:""})]),F=()=>{const e=y({uid:b(),item_id:null,request:1,code:"",name:"",stock:""});i.value.push(e),_(e),f()},_=e=>{v(()=>e.item_id,r=>{console.log("bindWatcher - newVal:",r),console.log("bindWatcher - row before update:",{code:e.code,name:e.name,stock:e.stock}),r?(e.code=r.code,e.name=r.name,e.stock=r.stock||0,e.unit=r.unit,console.log("bindWatcher - row after update:",{code:e.code,name:e.name,stock:e.stock})):(e.code="",e.name="",e.stock="",e.unit={})},{immediate:!0})};i.value.forEach(_),v(i,()=>{f()},{deep:!0});const j=e=>{console.log("Department changed to:",e),q(e),i.value=[y({uid:b(),item_id:null,request:1,code:"",name:"",stock:""})],_(i.value[0]),a.requests=[{uid:b(),item_id:null,request:1,note:""}],f()},U=e=>{i.value.splice(e,1),f()};n.user?.roles?.[0]?.name,console.log(n.user?.employee?.id);const a=R({request_no:n.requestNo,requested_at:new Date().toISOString().slice(0,10),department_id:n.user?.employee?.department?.id,employee_id:n.user?.employee?.id,requirement:"",requests:[{uid:b(),item_id:null,request:1,note:""}]});v(()=>a.department_id,(e,r)=>{e!==r&&j(e)}),O(()=>{a.department_id&&q(a.department_id)});function V(){a.requests=i.value.map((e,r)=>({uid:e.uid,item_id:e.item_id?.id??null,request:e.request,note:e.note??null})),a.post(route("material-requests.store"))}const B=y({}),C=y({});n.items.forEach(e=>{B[e.id]=0,C[e.id]=""});function A(){a.transform(e=>({...e,items:n.items.map(r=>({item_id:r.id,qty:Number(B[r.id]||0),notes:C[r.id]||""})).filter(r=>r.qty>0)})).post(route("material-requests.store"),{onFinish:()=>a.transform(e=>e)})}function D(){H.get(route("material-requests.index"))}return a.errors,(e,r)=>(p(),m(S,null,[g(u(W),{title:"Tambah Permintaan Barang"}),t("div",ee,[t("div",te,[g(Q,{items:T})]),t("div",re,[r[0]||(r[0]=t("h1",{class:"text-lg font-semibold text-gray-700 dark:text-gray-200"}," Buat Permintaan Barang ",-1)),g(X,{form:u(a),departments:n.departments,employees:h.employees,user:h.user,isEdit:!1,onSubmit:A,onCancel:D,onDepartmentChanged:j},null,8,["form","departments","employees","user"])]),t("div",se,[r[3]||(r[3]=t("div",{class:"flex items-center justify-between px-6 py-4"},[t("div",{class:"font-semibold text-gray-700 dark:text-gray-200"}," Daftar Item ")],-1)),t("div",ae,[t("table",oe,[r[2]||(r[2]=t("thead",null,[t("tr",null,[t("th",{class:"py-2.5 border-y border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex items-center justify-center"},[t("p",{class:"flex flex-col items-center font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," No. ")])]),t("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex items-center justify-center gap-2 px-3"},[t("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Nama Barang ")])]),t("th",{class:"py-3 border border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex cursor-pointer items-center justify-center gap-2 px-3"},[t("p",{class:"font-medium whitespace-nowrap text-gray-500 dark:text-gray-400"}," Kode Barang ")])]),t("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex items-center justify-center gap-2 px-3"},[t("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Stok Tersedia ")])]),t("th",{class:"py-3 border cursor-pointer border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex items-center justify-center gap-2 px-3"},[t("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Jumlah Permintaan ")])]),t("th",{class:"border-y border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"},[t("div",{class:"flex items-center justify-center"},[t("p",{class:"font-medium text-gray-500 whitespace-nowrap dark:text-gray-400"}," Aksi ")])])])],-1)),t("tbody",null,[(p(!0),m(S,null,K(i.value,(s,o)=>(p(),m("tr",{key:s.uid,class:"hover:bg-gray-100 cursor-pointer dark:hover:bg-gray-800"},[t("td",ie,[t("div",de,d(o+1)+". ",1)]),t("td",ne,[g(Z,{modelValue:s.item_id,"onUpdate:modelValue":c=>s.item_id=c,items:$(o),taggable:!0,"search-key":"name","label-key":"name",label:"Cari Barang",onTag:E,class:"w-full"},{item:N(({item:c})=>[t("div",le,[t("div",ce,[t("span",ue,d(c.name),1),P(c.id,o)?(p(),m("span",me," Dipilih ")):x("",!0)]),t("span",pe,d(c.code||"-"),1)])]),"no-options":N(()=>[...r[1]||(r[1]=[t("div",{class:"text-sm text-gray-500 p-2"}," Semua barang telah dipilih di baris lain ",-1)])]),_:2},1032,["modelValue","onUpdate:modelValue","items"]),u(a).errors[`requests.${o}.item_id`]?(p(),m("div",ye,d(u(a).errors[`requests.${o}.item_id`][0]),1)):x("",!0)]),t("td",ge,[t("div",be,[t("p",fe,d(s.code),1)])]),t("td",xe,[t("div",he,[t("p",_e,d(s.stock)+" "+d(s.unit?.short_name),1)])]),t("td",ke,[t("div",ve,[L(t("input",{"onUpdate:modelValue":c=>s.request=c,type:"number",min:"0",class:"w-24 rounded border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90"},null,8,qe),[[z,s.request]]),M(" "+d(s.unit?.short_name),1)]),u(a).errors[`requests.${o}.request`]?(p(),m("div",we,d(u(a).errors[`requests.${o}.request`]),1)):x("",!0)]),t("td",je,[t("div",Be,[t("button",{onClick:c=>U(o)},[g(Y,{class:"text-red-500"})],8,Ce)])])]))),128)),t("button",{type:"button",onClick:F,class:"m-4 px-3 py-2 text-white bg-green-500 hover:bg-green-600 rounded whitespace-nowrap"}," + Tambah Request ")])])]),u(a).errors.requests?(p(),m("div",De,d(u(a).errors.requests[0]),1)):x("",!0)]),t("div",{class:"flex items-center gap-5 justify-end"},[t("button",{type:"button",onClick:D,class:"inline-flex items-center rounded border bg-gray-400 border-gray-300 px-5 py-2 text-sm text-white hover:text-gray-800 hover:bg-gray-300 dark:border-gray-700 dark:text-gray-300"}," Batal "),t("button",{onClick:V,class:"inline-flex items-center rounded bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-60"}," Kirim Permintaan ")])])],64))}});export{We as default};
